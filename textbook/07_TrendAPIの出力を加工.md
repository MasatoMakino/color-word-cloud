# Google Trends APIの出力を加工する

この章では、Google Trendsの制限を回避し、出力を加工します。

    追加 : trend取得処理    47e8eae 2020/02/09 21:30

この章では引き続きこのコミットまでを対象とします。

## APIの制限内で利用する

前章でGoogle Trendsの制限を紹介しました。この制限を回避する方法を実装します。

### 基準語を設定する

まず、結果を相対値でしか受け取れない問題を考えます。相対値では複数の検索結果を比較できません。

この問題を解決するために、各検索に基準語を入れます。基準語の検索結果を常に100とし、他の検索結果を基準語に合わせて補正します。今回のコードでは"IVORY"を基準語としています。"IVORY"はテストで用意した色彩語リストの中で、ほどほどに利用されている語をピックアップしました。

次に、一度の検索で5つのワードしか扱えない問題を考えます。この問題も基準語を利用する事で解決できます。色彩語リストを基準語+4ワードずつに分割して検索し、その結果をまとめることで全色彩語の比較ができます。

## 結果を合成する

google-trends-apiパッケージは、node.js上で動作しますので、そのままではWebブラウザーに検索結果を渡せません。また、複数の検索結果をまとめる必要もあります。検索結果をまとめてJSONファイルとして保存し、そのファイルをWebブラウザーに渡します。

#### node-fetchパッケージ

Google Trendsを検索するため、node.jsでもWebブラウザーと同じ外部JSONを読み込む必要があります。この場合、Webブラウザーとnode.jsで同じ関数が流用できると、管理コストが下がります。しかし、Webブラウザーでサポートしている[Fetch API](https://developer.mozilla.org/ja/docs/Web/API/Fetch_API/Using_Fetch)がnode.js環境では利用できません。そこで[node-fetch](https://github.com/node-fetch/node-fetch)パッケージを導入します。

まず、npmコマンドをコンソールに入力してパッケージを導入します。

    npm install -D node-fetch

次に、`src/SheetLoader.js`にimport文を追加します。

```js
import fetch from "node-fetch";
```

これでnode.jsとWebブラウザーの両方でfetch関数が使えるようになりました。

### 分割して検索

node.js上で外部JSONを読み込んだら、そのリストを分割してGoogle Trendsで検索します。`src/SheetLoader.js`にgetColorNames関数を追加し、色の名前だけを配列として受け取れるようにします。`task/index.js`でその関数を読み込み、色名を取得したら4ワード+基準語単位で検索します。

### ファイル出力

検索結果をJSONファイルに保存します。node.jsの[fs (File System)](https://nodejs.org/api/fs.html) APIを使うとPC上にファイルを読み書きできます。結果は`docs/trends.js`というファイル名で保存し、Webブラウザー上から読み込めるようにします。

---

## 応用

### 基準語を変化させると検索結果にどう影響をあたえるか？

基準語はほどほどに利用されている色彩語をピックアップしましたが、この基準語を変更するとどのような結果になるでしょうか？手元のコードを変更して、変化を確認してみましょう。

### 検索範囲を絞り込んで、アプローチを変えるには？

Google Trendsでは時系列でのトレンドの変化や、国ごとのトレンドが比較できます。検索条件オプションに時期や国を設定した場合、どのような変化が現れるでしょうか？
